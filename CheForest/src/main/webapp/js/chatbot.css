/* CheForest AI ì±—ë´‡ ì „ìš© JavaScript */

class AIChatbot {
constructor() {
    this.isOpen = false;
    this.isTyping = false;
    this.currentUser = {
    nickname: 'ë‚´ ë‹‰ë„¤ì„', // JSPì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ë‹‰ë„¤ì„ìœ¼ë¡œ êµì²´
    grade: 'sprout', // JSPì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ë“±ê¸‰ìœ¼ë¡œ êµì²´
    avatar: '#3b82f6', // JSPì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ì•„ë°”íƒ€ ìƒ‰ìƒìœ¼ë¡œ êµì²´
    id: 'current' // JSPì—ì„œ ì‹¤ì œ ì‚¬ìš©ì IDë¡œ êµì²´
};

    this.chatHistory = [
{
    id: '1',
    text: 'ì•ˆë…•í•˜ì„¸ìš”! CheForest ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ¤–\nê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!',
    timestamp: new Date(),
    sender: 'bot'
}
];

    this.init();
}

init() {
    this.bindEvents();
    this.updateSendButton();
    this.setupSuggestedQuestions();
}

bindEvents() {
// í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­
const floatingBtn = document.getElementById('chatbotFloatingBtn');
    if (floatingBtn) {
    floatingBtn.addEventListener('click', () => this.openChatbot());
}

// ì±—ë´‡ì°½ ë‹«ê¸°
const closeChatbotBtn = document.getElementById('closeChatbotBtn');
    if (closeChatbotBtn) {
    closeChatbotBtn.addEventListener('click', () => this.closeChatbot());
}

// ë©”ì‹œì§€ ì „ì†¡
const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');

    if (sendBtn) {
    sendBtn.addEventListener('click', () => this.sendMessage());
}

    if (messageInput) {
    messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    this.sendMessage();
}
});

    messageInput.addEventListener('input', () => {
    this.updateSendButton();
});
}
}

setupSuggestedQuestions() {
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');
    suggestionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
    const question = btn.getAttribute('data-question');
    if (question) {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
    messageInput.value = question;
    this.updateSendButton();
    messageInput.focus();
}
}
});
});
}

openChatbot() {
    const chatbotWindow = document.getElementById('chatbotWindow');

    if (chatbotWindow) {
    chatbotWindow.classList.remove('hidden');
}

    this.isOpen = true;

// ì…ë ¥ì°½ í¬ì»¤ìŠ¤
setTimeout(() => {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
    messageInput.focus();
}
}, 300);

    this.scrollToBottom();
}

closeChatbot() {
    const chatbotWindow = document.getElementById('chatbotWindow');
    if (chatbotWindow) {
    chatbotWindow.classList.add('hidden');
}

    this.isOpen = false;
}

sendMessage() {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput || !messageInput.value.trim()) return;

    const messageText = messageInput.value.trim();

// ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
const userMessage = {
    id: Date.now().toString(),
    text: messageText,
    timestamp: new Date(),
    sender: 'user'
};

    this.chatHistory.push(userMessage);
    this.addMessage(userMessage);

// ì…ë ¥ì°½ ì´ˆê¸°í™”
messageInput.value = '';
    this.updateSendButton();

// ì¶”ì²œ ì§ˆë¬¸ ìˆ¨ê¸°ê¸° (ì²« ì§ˆë¬¸ í›„)
this.hideSuggestedQuestions();

// AI ì‘ë‹µ ìƒì„±
this.showTypingIndicator();
setTimeout(() => {
    this.hideTypingIndicator();
    this.generateBotResponse(messageText);
}, 1000 + Math.random() * 2000);

// ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì—¬ê¸°ì„œ ì„œë²„ë¡œ ì „ì†¡
// this.sendMessageToServer(messageText);
}

addMessage(messageData) {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;

    const messageElement = this.createMessageElement(messageData);

// íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì•ì— ì‚½ì…
const typingIndicator = document.getElementById('typingIndicator');
    const messagesEnd = document.getElementById('messagesEnd');

    if (typingIndicator && !typingIndicator.classList.contains('hidden')) {
    messagesContainer.insertBefore(messageElement, typingIndicator);
} else if (messagesEnd) {
    messagesContainer.insertBefore(messageElement, messagesEnd);
} else {
      messagesContainer.appendChild(messageElement);
  }

    this.scrollToBottom();
}

createMessageElement(messageData) {
    const messageDiv = document.createElement('div');
    const isBot = messageData.sender === 'bot';
    const isUser = messageData.sender === 'user';

    messageDiv.className = `message-item ${isUser ? 'user-message' : 'bot-message'}`;

    const gradeIcon = isBot ? 'ğŸŒ²' : this.getGradeIcon(this.currentUser.grade);
    const timeAgo = this.formatTimeAgo(messageData.timestamp);
    const nickname = isBot ? 'CheForest Bot' : this.currentUser.nickname;

    if (isUser) {
    messageDiv.innerHTML = `
<div class="message-content">
<div class="message-header">
<span class="user-badge">ë‚˜</span>
<span class="message-time">${timeAgo}</span>
<span class="user-grade">${gradeIcon}</span>
<span class="user-nickname">${nickname}</span>
</div>
<div class="message-bubble user-bubble">
<p>${messageData.text}</p>
</div>
</div>
<div class="user-avatar">
${nickname.charAt(0)}
</div>
`;
} else {
      messageDiv.innerHTML = `
  <div class="bot-avatar">
  ğŸ¤–
  </div>
  <div class="message-content">
  <div class="message-header">
  <span class="message-time">${timeAgo}</span>
  <span class="bot-grade">${gradeIcon}</span>
  <span class="bot-nickname">${nickname}</span>
  </div>
  <div class="message-bubble bot-bubble">
  <p>${messageData.text}</p>
  </div>
  </div>
  `;
  }

    return messageDiv;
}

generateBotResponse(userMessage) {
    let botResponse = '';

    if (userMessage.includes('ë ˆì‹œí”¼') || userMessage.includes('ìš”ë¦¬')) {
    botResponse = 'ë ˆì‹œí”¼ì— ê´€í•œ ì§ˆë¬¸ì´ì‹œë„¤ìš”! ğŸ³\n\nâ€¢ ë ˆì‹œí”¼ ì‘ì„±: í—¤ë”ì˜ "ë ˆì‹œí”¼" â†’ "ë ˆì‹œí”¼ ì‘ì„±í•˜ê¸°"\nâ€¢ ë ˆì‹œí”¼ ê²€ìƒ‰: ìƒë‹¨ ê²€ìƒ‰ì°½ ì´ìš©\nâ€¢ ì¹´í…Œê³ ë¦¬ë³„ ë ˆì‹œí”¼: í™ˆí˜ì´ì§€ ì¹´í…Œê³ ë¦¬ ë©”ë‰´\n\në” ìì„¸í•œ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ Q&A í˜ì´ì§€ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”!';
} else if (userMessage.includes('ë“±ê¸‰') || userMessage.includes('ìŠ¹ê¸‰')) {
    botResponse = 'ë“±ê¸‰ ì‹œìŠ¤í…œì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹œêµ°ìš”! â­\n\në“±ê¸‰ì€ ì”¨ì•— â†’ ë¿Œë¦¬ â†’ ìƒˆì‹¹ â†’ ë‚˜ë¬´ â†’ ìˆ² ìˆœì„œë¡œ ìŠ¹ê¸‰ë©ë‹ˆë‹¤.\n\nìŠ¹ê¸‰ ì¡°ê±´:\nâ€¢ ì‘ì„±í•œ ë ˆì‹œí”¼ ìˆ˜\nâ€¢ ë°›ì€ ì¢‹ì•„ìš” ìˆ˜\nâ€¢ íŒ”ë¡œì›Œ ìˆ˜\n\në“±ê¸‰ ì•ˆë‚´ í˜ì´ì§€ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”!';
} else if (userMessage.includes('ë¬¸ì œ') || userMessage.includes('ì˜¤ë¥˜') || userMessage.includes('ë²„ê·¸')) {
    botResponse = 'ë¬¸ì œê°€ ë°œìƒí•˜ì…¨ë‚˜ìš”? ğŸ˜…\n\në‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ì„œ Q&A ê²Œì‹œíŒì— ë¬¸ì˜í•´ì£¼ì„¸ìš”:\nâ€¢ ë°œìƒí•œ ë¬¸ì œ ìƒí™©\nâ€¢ ì‚¬ìš© ì¤‘ì¸ ê¸°ê¸°/ë¸Œë¼ìš°ì €\nâ€¢ ì˜¤ë¥˜ ë©”ì‹œì§€ (ìˆë‹¤ë©´)\n\nì—…ë¬´ì‹œê°„ ë‚´ì— ì‹ ì†íˆ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!';
} else if (userMessage.includes('ì•ˆë…•') || userMessage.includes('hi') || userMessage.includes('hello')) {
    botResponse = 'ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š\n\nCheForestì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\nì–¸ì œë“  ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”. ìµœì„ ì„ ë‹¤í•´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸŒ¿';
} else if (userMessage.includes('ê°ì‚¬') || userMessage.includes('ê³ ë§ˆì›Œ')) {
    botResponse = 'ë„ì›€ì´ ë˜ì—ˆë‹¤ë‹ˆ ì •ë§ ê¸°ë»ìš”! ğŸ˜Š\n\nCheForestì—ì„œ ë§›ìˆëŠ” ìš”ë¦¬ ì—¬ì •ì„ ì¦ê¸°ì‹œê¸¸ ë°”ëë‹ˆë‹¤!\në˜ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ½ï¸âœ¨';
} else if (userMessage.includes('íŒ') || userMessage.includes('ì¡°ì–¸')) {
    botResponse = 'ìš”ë¦¬ íŒì„ ì›í•˜ì‹œëŠ”êµ°ìš”! ğŸ‘¨â€ğŸ³\n\nìœ ìš©í•œ ìš”ë¦¬ íŒë“¤:\nâ€¢ ì–‘íŒŒ ì° ë•Œ ëˆˆë¬¼ ì•ˆ ë‚˜ê²Œ í•˜ë ¤ë©´ ëƒ‰ì¥ê³ ì— 30ë¶„ ë³´ê´€ í›„ ì°ê¸°\nâ€¢ ë§ˆëŠ˜ ì‰½ê²Œ ê¹Œë ¤ë©´ ì¹¼ë©´ìœ¼ë¡œ ëˆŒëŸ¬ ìœ¼ê¹¨ê¸°\nâ€¢ íŒŒìŠ¤íƒ€ ì‚¶ì„ ë•Œ ì†Œê¸ˆì„ ë„‰ë„‰íˆ ë„£ìœ¼ë©´ ë” ë§›ìˆì–´ìš”\nâ€¢ ê³ ê¸° êµ½ê¸° ì „ ì‹¤ì˜¨ì— 30ë¶„ ë‘ë©´ ë” ë¶€ë“œëŸ¬ì›Œì ¸ìš”\n\në” ë§ì€ íŒì€ ë ˆì‹œí”¼ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”!';
} else {
      botResponse = 'ì§ˆë¬¸í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ¤”\n\në” ì •í™•í•œ ë‹µë³€ì„ ìœ„í•´ Q&A ê²Œì‹œíŒì„ ì´ìš©í•˜ì‹œê±°ë‚˜,\në‹¤ìŒ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”:\n\nâ€¢ ë ˆì‹œí”¼ ê´€ë ¨ ì§ˆë¬¸\nâ€¢ ë“±ê¸‰/ìŠ¹ê¸‰ ë¬¸ì˜\nâ€¢ ê¸°ìˆ ì  ë¬¸ì œ\nâ€¢ ê³„ì • ê´€ë ¨ ë¬¸ì˜\nâ€¢ ìš”ë¦¬ íŒ\n\ní•­ìƒ ë„ì™€ë“œë¦´ ì¤€ë¹„ê°€ ë˜ì–´ìˆì–´ìš”! ğŸ’š';
  }

    const botMessage = {
    id: (Date.now() + 1).toString(),
text: botResponse,
timestamp: new Date(),
sender: 'bot'
};

    this.chatHistory.push(botMessage);
    this.addMessage(botMessage);
}

showTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
    typingIndicator.classList.remove('hidden');
    this.isTyping = true;
    this.scrollToBottom();
}
}

hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
    typingIndicator.classList.add('hidden');
    this.isTyping = false;
}
}

hideSuggestedQuestions() {
    const suggestedQuestions = document.getElementById('suggestedQuestions');
    if (suggestedQuestions && this.chatHistory.length > 1) {
    suggestedQuestions.style.display = 'none';
}
}

updateSendButton() {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    if (messageInput && sendBtn) {
    const hasText = messageInput.value.trim().length > 0;
    sendBtn.disabled = !hasText;
}
}

scrollToBottom() {
setTimeout(() => {
    const messagesEnd = document.getElementById('messagesEnd');
    if (messagesEnd) {
    messagesEnd.scrollIntoView({ behavior: 'smooth' });
}
}, 100);
}

getGradeIcon(grade) {
    const gradeIcons = {
    seed: 'ğŸŒ±',
    root: 'ğŸŒ¿',
    sprout: 'ğŸŒ±',
    tree: 'ğŸŒ³',
    forest: 'ğŸŒ²'
};
    return gradeIcons[grade] || 'ğŸŒ±';
}

formatTimeAgo(date) {
    const now = new Date();
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));

    if (diffInMinutes < 1) {
    return 'ë°©ê¸ˆ ì „';
} else if (diffInMinutes < 60) {
    return `${diffInMinutes}ë¶„ ì „`;
} else if (diffInMinutes < 1440) {
    return `${Math.floor(diffInMinutes / 60)}ì‹œê°„ ì „`;
} else {
      return date.toLocaleDateString('ko-KR', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
  });
  }
}

// ì„œë²„ í†µì‹  ë©”ì„œë“œ (JSPì—ì„œ êµ¬í˜„)
sendMessageToServer(messageText) {
fetch('/api/ai-chatbot/send', {
    method: 'POST',
    headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
    message: messageText,
    timestamp: new Date().toISOString(),
    userId: this.currentUser.id
})
})
.then(response => response.json())
.then(data => {
    if (data.response) {
    const botMessage = {
    id: data.id || Date.now().toString(),
    text: data.response,
    timestamp: new Date(),
    sender: 'bot'
};

    this.chatHistory.push(botMessage);
    this.addMessage(botMessage);
}
})
.catch(error => {
    console.error('AI ì±—ë´‡ ìš”ì²­ ì‹¤íŒ¨:', error);

// ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
const errorMessage = {
    id: Date.now().toString(),
    text: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
    timestamp: new Date(),
    sender: 'bot'
};

    this.chatHistory.push(errorMessage);
    this.addMessage(errorMessage);
});
}

// ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” (ì„ íƒì‚¬í•­)
clearChatHistory() {
    this.chatHistory = [this.chatHistory[0]]; // ì´ˆê¸° ì¸ì‚¬ ë©”ì‹œì§€ë§Œ ë‚¨ê¹€
const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
// ì´ˆê¸° ë©”ì‹œì§€ ì œì™¸í•˜ê³  ëª¨ë“  ë©”ì‹œì§€ ì œê±°
const messageItems = messagesContainer.querySelectorAll('.message-item:not(:first-child)');
    messageItems.forEach(item => {
    if (!item.id || item.id !== 'typingIndicator') {
    item.remove();
}
});
}

// ì¶”ì²œ ì§ˆë¬¸ ë‹¤ì‹œ í‘œì‹œ
const suggestedQuestions = document.getElementById('suggestedQuestions');
    if (suggestedQuestions) {
    suggestedQuestions.style.display = 'block';
}
}
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
   document.addEventListener('DOMContentLoaded', function() {
// AI ì±—ë´‡ ì»¨í…Œì´ë„ˆê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
if (document.querySelector('.ai-chatbot-container')) {
window.aiChatbot = new AIChatbot();

// Lucide ì•„ì´ì½˜ ì´ˆê¸°í™” (ìˆëŠ” ê²½ìš°)
if (window.lucide) {
window.lucide.createIcons();
}
}
});